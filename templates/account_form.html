
{% load i18n static %}
<div class="form-container">
  <div class="bg-outline text-center w-100 py-3">PRUEBA 1 MES <strong>GRATIS</strong></div><br />
    <div class="text-center">Si quieres probar durante 1 mes gratis, rellena el siguiente formulario y nos pondremos en contacto contigo:</div><br />
      <form id="contactForm-ext" novalidate>
	<input type="hidden" name="next" value="{% url 'index' %}" />
        <div class="row">
          <div class="field">
            <label for="name">Nombre</label>
            <input id="name" name="name" type="text" class="form-control"  placeholder="Ej. María Pérez" required>
            <div class="error-msg" aria-live="polite" id="nameError"></div>
          </div>
        </div>

        <div class="row my-2">
          <div class="field">
            <label for="email">Correo electrónico</label>
            <input id="email" name="email" type="email" class="form-control"  placeholder="tu@ejemplo.com" required>
            <div class="error-msg alert alert-danger text-white small p-1 bg-danger mt-1" aria-live="polite" id="emailError"></div>
          </div>
        </div>

        <div class="row my-2">
          <div class="field">
            <label for="phone">Teléfono</label>
            <input id="phone" name="phone" type="tel" class="form-control"  placeholder="600 123 456" pattern="^[+]?\d[\d\s-]{6,}$" required>
            <div class="error-msg alert alert-danger text-white small p-1 bg-danger mt-1" aria-live="polite" id="phoneError"></div>
          </div>
        </div>
        <!-- Add captcha here -->
        <div class="row my-2">
          <div class="field">
            <label for="captcha">¿Sabes matemáticas? <span id="captchaQuestion" aria-live="polite"></span></label>
            <input id="captcha" name="captcha" type="text" class="form-control" autocomplete="off" placeholder="Respuesta" required aria-describedby="captchaError">
            <div class="hint small">Resuelve la operación para verificar que no eres un robot.</div>
            <div class="error-msg bg-danger text-white hide alert alert-danger mt-1" aria-live="polite" id="captchaError"></div>
          </div>
        </div>

        <script>
          $(".error-msg").hide();

        (function(){
          const form = document.getElementById('contactForm-ext');
          const qEl = document.getElementById('captchaQuestion');
          const input = document.getElementById('captcha');
          const errEl = document.getElementById('captchaError');
          let expected = null;

          function newChallenge(){
            const a = Math.floor(Math.random() * 9) + 1;
            const b = Math.floor(Math.random() * 9) + 1;
            expected = a + b;
            qEl.textContent = a + ' + ' + b + ' = ?';
            input.value = '';
            clearError();
          }

          function setError(msg){
            if(msg){
              newChallenge();

              input.classList.add('error');
              errEl.textContent = msg;
              input.setAttribute('aria-invalid','true');
              setTimeout(() => {
                clearError();
              }, 5000);
              
            } else {
              input.classList.remove('error');
              errEl.textContent = '';
              input.removeAttribute('aria-invalid');
              
            }
          }

          function clearError(){ setError(''); }

          newChallenge();

          // regenerate on form reset
          form.addEventListener('reset', function(){
            // small timeout so visual reset completes first
            setTimeout(newChallenge, 0);
          });

          // validate captcha before the main submit handler runs.
          form.addEventListener('submit', function(e){

            // Check email format
            const emailInput = document.getElementById('email');
            const emailVal = emailInput.value.trim();
            const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if(!emailPattern.test(emailVal)){
              $("#emailError").text('Correo electrónico no válido').show();
              emailInput.focus();
              emailInput.classList.add('error');
              emailInput.setAttribute('aria-invalid','true');
              $("#emailError").fadeOut(5000);
              e.preventDefault();
              e.stopImmediatePropagation();
              return;
            }

            const val = input.value.trim();
            if(!val){
              setError('Responde al captcha');
              Swal.fire(
                'Error',
                'Responde al captcha para continuar.',
                'error',
                {allowOutsideClick: false}
              );
              e.preventDefault();
              e.stopImmediatePropagation();
              input.focus();
              return;
            }
            if(parseInt(val, 10) !== expected){
              setError('Respuesta incorrecta');
              $("captchaError").text('Respuesta incorrecta');
              $("#captchaError").show();
              $("#captchaError").fadeOut(5000);


              e.preventDefault();
              e.stopImmediatePropagation();
              input.focus();
              return;
            }

            // Check email format
            clearError();
            // Send by jquery ajax instead of normal submit
            e.preventDefault();
            $.ajax({
              url: "{% url 'ask-4-test-period' %}",
              method: "POST",
              data: {
                name: document.getElementById('name').value,
                email: document.getElementById('email').value,
                phone: document.getElementById('phone').value,
                captcha: input.value,
                csrfmiddlewaretoken: '{{ csrf_token }}'
              },
              success: function(data){
                Swal.fire(
                  '¡Formulario enviado!',
                  'Gracias por contactar con nosotros. Te responderemos lo antes posible.',
                  'success'
                );
                form.reset();
              },
              error: function(xhr, status, error){
                let msg = "Error enviando el formulario.";
                if(xhr.responseJSON && xhr.responseJSON.message){
                  msg = xhr.responseJSON.message;
                }
                Swal.fire(
                  'Error',
                  msg,
                  'error'
                );
                newChallenge();
              }
            });
            // let other handlers proceed
          }, false);
        })();
        </script>

        <div class="actions mt-5">
          <button type="submit" class="btn btn-primary btn-block mt-2 w-100">Enviar</button>
          <button type="reset" class="btn btn-outline btn-block mt-2 w-100">Limpiar</button>
        </div>
      </form>
   </div>

  <script>
    // Validación simple y accesible
    (function(){
      const form = document.getElementById('contactForm');
      const nameEl = document.getElementById('name');
      const emailEl = document.getElementById('email');
      const phoneEl = document.getElementById('phone');

      function setError(el, msg){
        const err = document.getElementById(el.id + 'Error');
        if(msg){
          el.classList.add('error');
          err.textContent = msg;
          el.setAttribute('aria-invalid','true');
        } else {
          el.classList.remove('error');
          err.textContent = '';
          el.removeAttribute('aria-invalid');
        }
      }

      form.addEventListener('submit', function(e){
        e.preventDefault();
        let ok = true;

        if(!nameEl.value.trim()){ setError(nameEl, 'El nombre es obligatorio'); ok = false; } else setError(nameEl,'');

        if(!emailEl.checkValidity()){ setError(emailEl, 'Introduce un correo válido'); ok = false; } else setError(emailEl,'');

        if(!phoneEl.checkValidity()){ setError(phoneEl, 'Introduce un teléfono válido (mín. 7 dígitos)'); ok = false; } else setError(phoneEl,'');

        if(!ok) return;

        // Aquí enviarías los datos con fetch/XHR. Por ahora mostramos un aviso.
        alert('Formulario enviado:\nNombre: ' + nameEl.value + '\nEmail: ' + emailEl.value + '\nTeléfono: ' + phoneEl.value);
        form.reset();
      });

      form.addEventListener('reset', function(){
        setError(nameEl,''); setError(emailEl,''); setError(phoneEl,'');
      });
    })();
  </script>


